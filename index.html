<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Officer Task Status Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; padding: 20px; background-color: #f4f6f8; color: #333; }
        .container { max-width: 1400px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
        
        .summary-cards { display: flex; justify-content: center; gap: 20px; margin-bottom: 30px; flex-wrap: wrap; }
        .card { padding: 20px; border-radius: 8px; color: white; width: 200px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card h3 { margin: 0; font-size: 1.1em; opacity: 0.9; }
        .card p { margin: 10px 0 0; font-size: 2.5em; font-weight: bold; }
        .bg-green { background-color: #2ecc71; }
        .bg-red { background-color: #e74c3c; }
        .bg-blue { background-color: #3498db; }

        .dashboard-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 1100px) { .dashboard-grid { grid-template-columns: 1fr; } }

        .section-title { font-size: 1.2em; font-weight: 600; color: #34495e; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 8px; overflow: hidden; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
        th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #eee; font-size: 0.95em; }
        th { background-color: #34495e; color: white; font-weight: 600; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px; }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #f8f9fa; }
        
        .badge { padding: 5px 10px; border-radius: 20px; font-weight: 600; font-size: 0.85em; display: inline-block; }
        .badge-completed { background-color: #d5f5e3; color: #27ae60; }
        .badge-incomplete { background-color: #fadbd8; color: #c0392b; }
        .badge-error { background-color: #fcf3cf; color: #f39c12; }

        .loading-text { text-align: center; color: #7f8c8d; margin: 20px; font-style: italic; }
        .refresh-btn { display: block; margin: 20px auto 0; padding: 10px 20px; background-color: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1em; transition: background 0.3s; }
        .refresh-btn:hover { background-color: #2980b9; }
        .timestamp { text-align: right; color: #95a5a6; font-size: 0.85em; margin-top: 15px; }

        .chart-container { position: relative; height: 400px; width: 100%; margin-top: 40px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Officer Task Status Dashboard</h1>
        
        <div class="summary-cards">
            <div class="card bg-green">
                <h3>Officers Completed</h3>
                <p id="count-completed">-</p>
            </div>
            <div class="card bg-red">
                <h3>Officers Incomplete</h3>
                <p id="count-incomplete">-</p>
            </div>
            <div class="card bg-blue">
                <h3>Total Officers</h3>
                <p id="count-total">-</p>
            </div>
        </div>

        <div id="loading" class="loading-text">Fetching data from Google Sheets...</div>
        
        <div class="dashboard-grid" id="main-content" style="display: none;">
            <div>
                <div class="section-title">Weekly Status (Individual Sheets)</div>
                <table id="status-table">
                    <thead>
                        <tr>
                            <th>Officer Name</th>
                            <th>Status</th>
                            <th>Incomplete Tasks</th>
                        </tr>
                    </thead>
                    <tbody id="table-body"></tbody>
                </table>
            </div>
            <div>
                <div class="section-title">Task Statistics (Aggregate Data)</div>
                <table id="stats-table">
                    <thead>
                        <tr>
                            <th>Officer Name</th>
                            <th>Completed (Last 7 Days)</th>
                            <th>Total Pending</th>
                        </tr>
                    </thead>
                    <tbody id="stats-body"></tbody>
                </table>
            </div>
        </div>

        <div class="chart-container" id="chart-section" style="display: none;">
            <div class="section-title">Weekly Incomplete Tasks (From Individual Sheets)</div>
            <canvas id="pendingChart"></canvas>
        </div>

        <button class="refresh-btn" onclick="refreshData()">Refresh Data</button>
        <div class="timestamp" id="last-updated"></div>
    </div>

    <script>
        const SPREADSHEET_ID = '1jspebqSTXgEtYyxYAE47_uRn6RQKFlHQhneuQoGiCok'; // Main sheet with officers
        const AGGREGATE_SHEET_ID = '14-idXJHzHKCUQxxaqGZi-6S0G20gvPUhK4G16ci2FwI'; // New sheet
        const AGGREGATE_GID = '213021534';

        const OFFICERS = [
            { name: "ADC (G)", gid: "174981592" },
            { name: "ADC (D)", gid: "537074213" },
            { name: "ADC (UD)", gid: "846764018" },
            { name: "ADC K", gid: "1476602908" },
            { name: "ADC J", gid: "18822170" },
            { name: "ACG", gid: "1291568180" },
            { name: "CMFO", gid: "1227420096" },
            { name: "SDM East", gid: "33416154" },
            { name: "SDM West", gid: "52989510" },
            { name: "SDM Raikot", gid: "1833732603" },
            { name: "SDM Samrala", gid: "190794459" },
            { name: "SDM Khanna", gid: "2054147547" },
            { name: "SDM Jargon", gid: "278920499" },
            { name: "SDM Payal", gid: "778489712" },
            { name: "DRO", gid: "501565659" },
            { name: "RTA", gid: "1563439729" }
        ];

        let pendingChartInstance = null;

        // Generic fetcher for GVIZ
        function fetchGvizData(sheetId, gid) {
            return new Promise((resolve) => {
                const callbackName = 'callback_' + gid + '_' + Math.floor(Math.random() * 100000);
                
                const timeout = setTimeout(() => {
                    cleanup();
                    console.error(`Timeout fetching GID ${gid}`);
                    resolve(null); 
                }, 15000);

                window[callbackName] = (data) => {
                    cleanup();
                    resolve(data);
                };

                const script = document.createElement('script');
                script.src = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=responseHandler:${callbackName}&gid=${gid}&_=${Date.now()}`;
                script.onerror = () => {
                    cleanup();
                    console.error(`Script error fetching GID ${gid}`);
                    resolve(null);
                };
                document.body.appendChild(script);

                function cleanup() {
                    clearTimeout(timeout);
                    delete window[callbackName];
                    if (script.parentNode) script.parentNode.removeChild(script);
                }
            });
        }

        function analyzeOfficerData(data) {
            if (!data || !data.table) return { status: 'Error', count: -1 };
            const cols = data.table.cols;
            const rows = data.table.rows;

            // Find last column with name "Status"
            let statusIdx = -1;
            for (let i = 0; i < cols.length; i++) {
                if (cols[i].label && cols[i].label.trim().toLowerCase() === 'status') {
                    statusIdx = i;
                }
            }

            if (statusIdx === -1) return { status: 'Structure Error', count: -1 };

            let incompleteCount = 0;
            for (const row of rows) {
                if (!row.c) continue;
                const cell = row.c[statusIdx];
                if (cell && cell.v) {
                    const val = String(cell.v).toLowerCase();
                    if (val.includes('pending') || val.includes('incomplete')) {
                        incompleteCount++;
                    }
                }
            }
            return { status: incompleteCount > 0 ? 'Incomplete' : 'Completed', count: incompleteCount };
        }

        function processAggregateData(data) {
            if (!data || !data.table) return [];

            const rows = data.table.rows;
            const officerStats = {};
            const now = new Date();
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(now.getDate() - 7);

            for (const row of rows) {
                if (!row.c) continue;
                
                const officerCell = row.c[1];
                const dateCell = row.c[8];
                const statusCell = row.c[9];

                if (!officerCell || !officerCell.v) continue;
                const officerName = String(officerCell.v).trim();
                
                if (!officerStats[officerName]) {
                    officerStats[officerName] = { completedRecent: 0, pending: 0 };
                }

                const status = statusCell && statusCell.v ? String(statusCell.v).toLowerCase() : '';
                
                // Parse date
                let entryDate = null;
                if (dateCell && dateCell.v) {
                    const dateStr = String(dateCell.v);
                    const match = dateStr.match(/Date\((\d+),(\d+),(\d+)\)/);
                    if (match) {
                        entryDate = new Date(parseInt(match[1]), parseInt(match[2]), parseInt(match[3]));
                    }
                }

                if (status === 'completed') {
                    if (entryDate && entryDate >= sevenDaysAgo) {
                        officerStats[officerName].completedRecent++;
                    }
                } else {
                    officerStats[officerName].pending++;
                }
            }
            
            return Object.keys(officerStats).map(name => ({
                name: name,
                completedRecent: officerStats[name].completedRecent,
                pending: officerStats[name].pending
            }));
        }

        async function refreshData() {
            const loading = document.getElementById('loading');
            const mainContent = document.getElementById('main-content');
            const chartSection = document.getElementById('chart-section');
            
            loading.style.display = 'block';
            mainContent.style.display = 'none';
            chartSection.style.display = 'none';

            // 1. Fetch Officer Statuses (Left Table)
            const officerPromises = OFFICERS.map(async (officer) => {
                const data = await fetchGvizData(SPREADSHEET_ID, officer.gid);
                let result = { status: 'Error', count: 0 };
                if (data && data.status !== 'error') {
                    result = analyzeOfficerData(data);
                }
                return { name: officer.name, status: result.status, count: result.count };
            });

            // 2. Fetch Aggregate Data (Right Table)
            const aggregatePromise = fetchGvizData(AGGREGATE_SHEET_ID, AGGREGATE_GID);

            const [officerResults, aggregateData] = await Promise.all([
                Promise.all(officerPromises),
                aggregatePromise
            ]);

            // Render Officer Table (Left)
            const statusTableBody = document.getElementById('table-body');
            statusTableBody.innerHTML = '';
            let totalCompleted = 0;
            let totalIncomplete = 0;

            officerResults.forEach(res => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${res.name}</td>
                    <td><span class="badge ${res.status === 'Completed' ? 'badge-completed' : (res.status === 'Incomplete' ? 'badge-incomplete' : 'badge-error')}">${res.status}</span></td>
                    <td style="${res.count > 0 ? 'color: #c0392b; font-weight: bold;' : 'color: #27ae60;'}">${res.count >= 0 ? res.count : '-'}</td>
                `;
                statusTableBody.appendChild(tr);

                if (res.status === 'Completed') totalCompleted++;
                if (res.status === 'Incomplete') totalIncomplete++;
            });

            document.getElementById('count-completed').innerText = totalCompleted;
            document.getElementById('count-incomplete').innerText = totalIncomplete;
            document.getElementById('count-total').innerText = OFFICERS.length;

            // Render Aggregate Table (Right)
            const statsTableBody = document.getElementById('stats-body');
            statsTableBody.innerHTML = '';
            const stats = processAggregateData(aggregateData);
            stats.sort((a, b) => b.pending - a.pending);

            stats.forEach(stat => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${stat.name}</td>
                    <td>${stat.completedRecent}</td>
                    <td style="${stat.pending > 0 ? 'color: #c0392b; font-weight: bold;' : ''}">${stat.pending}</td>
                `;
                statsTableBody.appendChild(tr);
            });

            // Render Chart - USING OFFICER RESULTS (Individual Sheets)
            // Filter to show only officers with pending tasks for better visibility, or all?
            // Let's show all to be consistent.
            renderChart(officerResults);

            // Show UI
            loading.style.display = 'none';
            mainContent.style.display = 'grid';
            chartSection.style.display = 'block';
            document.getElementById('last-updated').innerText = 'Last Updated: ' + new Date().toLocaleString();
        }

        function renderChart(officerData) {
            const ctx = document.getElementById('pendingChart').getContext('2d');
            
            if (pendingChartInstance) {
                pendingChartInstance.destroy();
            }

            // Use the data from individual sheets
            const labels = officerData.map(o => o.name);
            const data = officerData.map(o => Math.max(0, o.count)); // Ensure no -1s

            pendingChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Incomplete Tasks (Weekly)',
                        data: data,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)',
                        borderColor: 'rgba(231, 76, 60, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            stepSize: 1,
                            suggestedMax: 5 // Ensure small numbers look okay
                        }
                    }
                }
            });
        }

        refreshData();
    </script>
</body>
</html>
